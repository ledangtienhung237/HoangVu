<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B·∫£ng B√°o Gi√° (C·∫£i ti·∫øn)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    body {font-family: Arial, sans-serif; margin:0; padding:20px; background:#f7f7fb; color:#0f172a;}
    .container {max-width: 900px; margin: auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding:20px;}
    header {display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:20px;}
    header img {max-height:60px;}
    h1 {margin:0; font-size:24px; font-weight:700;}
    .search-wrap {position: relative;}
    .search {width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;}
    .results {position:absolute; top:110%; left:0; right:0; background:#fff; border:1px solid #ccc; border-radius:8px; max-height:200px; overflow:auto; list-style:none; margin:0; padding:0; z-index:1000;}
    .results[hidden] {display:none;}
    .results li {padding:8px 10px; cursor:pointer; border-bottom:1px solid #eee; display:flex; justify-content:space-between;}
    .results li:hover {background:#f0f0f0;}
    table {width:100%; border-collapse:collapse; margin-top:16px;}
    th, td {border:1px solid #ddd; padding:8px; text-align:left;}
    th {background:#f9fafb; position:sticky; top:0;}
    td input {width:100%; padding:6px; border:1px solid #ccc; border-radius:6px;}
    .toolbar {margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;}
    .btn {padding:8px 14px; border:none; border-radius:6px; background:#2563eb; color:#fff; cursor:pointer;}
    .btn:hover {background:#1d4ed8;}
    .btn.ghost {background:#fff; color:#2563eb; border:1px solid #2563eb;}
    .totals {margin-top:16px; padding:12px; border-top:2px solid #eee; display:flex; justify-content:space-between; align-items:center;}
    .grand {font-size:18px; font-weight:bold;}
    .note {font-size:13px; color:#555; margin-top:8px;}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <img id="logo-img" src="ayas.png" alt="Logo Ayas">
      <h1>B·∫£ng B√°o Gi√°</h1>
    </header>

    <div class="search-wrap">
      <input id="product-search" class="search" placeholder="T√¨m s·∫£n ph·∫©m...">
      <ul id="search-results" class="results" hidden></ul>
    </div>

    <div class="toolbar">
      <button class="btn" id="btn-add-row">‚ûï Th√™m s·∫£n ph·∫©m</button>
      <button class="btn ghost" id="btn-clear-all">üßπ X√≥a t·∫•t c·∫£</button>
    </div>

    <table id="quote-table">
      <thead>
        <tr>
          <th>T√™n s·∫£n ph·∫©m</th>
          <th>ƒê∆°n gi√°</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Chi·∫øt kh·∫•u (%)</th>
          <th>Th√†nh ti·ªÅn</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="product-body"></tbody>
    </table>

    <div class="totals">
      <div>
        <span>Chi·∫øt kh·∫•u to√†n ƒë∆°n (%): <input id="order-discount" type="number" value="0" min="0" max="100" style="width:70px"></span>
      </div>
      <div class="grand">T·ªïng c·ªông: <span id="grand-total">0</span> ƒë</div>
    </div>

    <div class="toolbar">
      <button class="btn" id="btn-export-text">üìÑ Xu·∫•t vƒÉn b·∫£n</button>
      <button class="btn ghost" id="btn-copy-text">üìã Sao ch√©p</button>
      <button class="btn" id="btn-export-html">üßæ Xu·∫•t b·∫£ng</button>
      <button class="btn ghost" id="btn-capture">üñºÔ∏è Xu·∫•t ·∫£nh</button>
    </div>

    <div id="export-output" class="note" style="white-space:pre-wrap;background:#f4f4f4;padding:10px;margin-top:10px;"></div>
    <div id="capture-area" style="margin-top:20px;"></div>
  </div>

  <script>
    // ===== Utils =====
    const VND = n => new Intl.NumberFormat('vi-VN').format(Math.round(Number(n)||0));
    const clamp = (v,min,max)=> Math.min(max, Math.max(min, Number(v)||0));
    const escAttr = s => String(s)
      .replaceAll('&','&amp;')
      .replaceAll('"','&quot;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');

    // ===== State =====
    let productList = [];

    // Load product list safely (avoids Unexpected token '<' if server returns HTML)
    (async function loadProducts(){
      try{
        const r = await fetch('ayas.json', {cache:'no-store'});
        const text = await r.text();
        if(text.trim().startsWith('<')) throw new Error('Expected JSON, got HTML');
        const data = JSON.parse(text);
        if(Array.isArray(data)){
          productList = data;
          localStorage.setItem('fullProductList', JSON.stringify(data));
        }
      }catch(err){
        console.warn('Kh√¥ng t·∫£i ƒë∆∞·ª£c ayas.json, d√πng d·ªØ li·ªáu localStorage n·∫øu c√≥.', err);
        try{ productList = JSON.parse(localStorage.getItem('fullProductList')||'[]'); }catch{ productList=[]; }
      }
    })();

    const els={
      search:document.getElementById('product-search'),
      results:document.getElementById('search-results'),
      tbody:document.getElementById('product-body'),
      grand:document.getElementById('grand-total'),
      orderDiscount:document.getElementById('order-discount')
    };

    function addRow(name='', price=0, qty=1, disc=0){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="name" value="${escAttr(name)}"></td>
        <td><input type="number" class="price" value="${Math.max(0,Math.floor(Number(price)||0))}"></td>
        <td><input type="number" class="qty" value="${Math.max(0,Math.floor(Number(qty)||1))}"></td>
        <td><input type="number" class="disc" value="${clamp(disc,0,100)}" min="0" max="100" step="0.01"></td>
        <td class="line-total">0</td>
        <td><button class="btn ghost btn-del">üóëÔ∏è</button></td>`;
      els.tbody.appendChild(tr);
      recalc();
    }

    function recalc(){
      let total=0;
      els.tbody.querySelectorAll('tr').forEach(tr=>{
        const price=+tr.querySelector('.price').value||0;
        const qty=+tr.querySelector('.qty').value||0;
        const disc=clamp(tr.querySelector('.disc').value,0,100);
        const line=Math.max(0, price*qty*(1-disc/100));
        tr.querySelector('.line-total').textContent=VND(line);
        total+=line;
      });
      const orderDisc=clamp(els.orderDiscount.value,0,100);
      total*=1-orderDisc/100;
      els.grand.textContent=VND(total);
    }

    els.tbody.addEventListener('input',recalc);
    els.tbody.addEventListener('click',e=>{if(e.target.classList.contains('btn-del')){e.target.closest('tr').remove();recalc();}});
    els.orderDiscount.addEventListener('input',recalc);

    // Debounced search + safe rendering
    let timer=0;
    els.search.addEventListener('input',()=>{
      clearTimeout(timer);
      timer=setTimeout(()=>{
        const kw=els.search.value.toLowerCase().trim();
        els.results.innerHTML='';
        if(!kw){els.results.hidden=true;return;}
        const matches=(productList||[]).filter(p=>String(p.name).toLowerCase().includes(kw)).slice(0,50);
        matches.forEach(p=>{
          const li=document.createElement('li');
          li.textContent=`${p.name} - ${VND(p.price)} ƒë`;
          li.addEventListener('click',()=>{addRow(p.name,p.price,1,0);els.results.hidden=true;els.search.value='';});
          els.results.appendChild(li);
        });
        els.results.hidden=!matches.length;
      },120);
    });

    document.getElementById('btn-add-row').addEventListener('click',()=>addRow());
    document.getElementById('btn-clear-all').addEventListener('click',()=>{els.tbody.innerHTML='';recalc();});

    // ===== Export functions =====
    document.getElementById('btn-export-text').addEventListener('click',()=>{
      let text='';
      els.tbody.querySelectorAll('tr').forEach((tr,i)=>{
        const name=tr.querySelector('.name').value;
        const price=VND(tr.querySelector('.price').value);
        const qty=tr.querySelector('.qty').value;
        const disc=tr.querySelector('.disc').value;
        const tt=tr.querySelector('.line-total').textContent;
        text+=`${i+1}. ${name}
   ƒê∆°n gi√°: ${price} ƒë | SL: ${qty} | CK: ${disc}% | Th√†nh ti·ªÅn: ${tt} ƒë
`;
      });
      text+=`
T·ªïng c·ªông: ${els.grand.textContent} ƒë`;
      document.getElementById('export-output').textContent=text;
    });

    document.getElementById('btn-copy-text').addEventListener('click',()=>{
      navigator.clipboard.writeText(document.getElementById('export-output').textContent).then(()=>alert('ƒê√£ sao ch√©p!'));
    });

    document.getElementById('btn-export-html').addEventListener('click',()=>{
      document.getElementById('capture-area').innerHTML=document.getElementById('quote-table').outerHTML;
    });

    document.getElementById('btn-capture').addEventListener('click',async()=>{
      const el=document.getElementById('quote-table');
      const canvas=await html2canvas(el, {scale:2, backgroundColor:'#fff'});
      const a=document.createElement('a');
      a.href=canvas.toDataURL('image/png');
      a.download='bao_gia.png';
      a.click();
    });

    // ===== Smoke tests (non-intrusive) =====
    (function tests(){
      try{
        console.assert(escAttr('"&<>`‚Ñ¢')==='&quot;&amp;&lt;&gt;`‚Ñ¢','escAttr failed');
        const special='Clarity SL 20 c√°i, 018 "A" & <B>';
        addRow(special, 12345, 1, 0);
        const val=els.tbody.querySelector('.name').value;
        console.assert(val===special,'addRow attribute escape failed');
        els.tbody.innerHTML='';
        console.log('[OK] smoke tests passed');
      }catch(e){ console.warn('Smoke tests failed', e); }
    })();
  </script>
</body>
</html>
